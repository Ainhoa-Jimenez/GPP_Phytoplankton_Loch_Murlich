---
title: "PHytoplankton count"
author: "Ainhoa"
date: "2023-10-06"
output: html_document
---

Code related to statistical analysis of the Phytoplankton Abundance

1.  Install and load packages

```{r, message=FALSE}
library("readxl")
library("dplyr")
library("ggplot2")
library("lme4")
library("tidyverse")
library("MuMIn")
library("stringr")
library("dunn.test")
library("openxlsx")
```

2.  Load data

```{r, warning=FALSE}
plankton_total <- read_xlsx("data_lake_v7.xlsx", sheet = "Pretty_Plankton") |>
 #make first adjustment needed. Put the mean number of 
   mutate(mean_per_ul = as.numeric(mean_per_ul))%>%
  mutate(treatment= as.factor(treatment))
```

# Phytoplankton abundance vs Treatment

## Data excluding monday

```{r}
#select measuremnets taken on day 1 (Monday)
plankton_no_monday <- plankton_total |>
  filter(!date == "Mon")
```

Check the structure of the data distribution:

```{r}
hist(plankton_no_monday$mean_per_ul, 
     xlab = "Mean phytoplankton abundance per uL",
     ylab = "Frequency",
     bins = 1)
```

The data is too skewed to the left to be a normal distribution (needed to use linear models).

Try logging the data

```{r}
(ggplot(plankton_no_monday, aes(x=log(mean_per_ul))) +
  geom_histogram(binwidth = 0.5)+
   labs(x = "Log of Mean Phytoplankton Abundance per uL",
    y = "Frequency"))
```

Looks much better.

3.  Conduct a linear model on Monday data

```{r}
#first need to remove NA
plankton_no_monday_clean<-plankton_no_monday%>%
  na.omit(plankton_no_monday$mean_per_ul)
##------

p_m1 <- lm(log(mean_per_ul) ~ treatment, data = plankton_no_monday_clean)
summary(p_m1)
anova(p_m1)
plot(p_m1)

#normality
p_m1_resids <- resid(p_m1)
shapiro.test(p_m1_resids)
#homoscedasticity
bartlett.test(log(mean_per_ul) ~ treatment, data = plankton_no_monday_clean)

### Model meets the necessary assumptions meets assumptions
```

This model tells us there is no differencece between treatments

4.  Try with mixed linear model, adding site as a random variable

```{r}
p_m3 <- lmer( mean_per_ul ~ treatment + (1|site), data = plankton_no_monday_clean, REML = FALSE)
summary(p_m3)

p_m4 <- lmer( mean_per_ul ~ 1 + (1|site), data = plankton_no_monday_clean, REML = FALSE)
summary(p_m3)

AIC(p_m1, p_m3, p_m4)
```

p_m4 explains more than p_m3 (lower AICc). Adding treatment does not improve the model. Site might have an effect

5.  Create the graphs

```{r}

#create a summary for the data set

summary_plankton<- group_by(plankton_no_monday_clean, treatment) %>%
 summarise(
    count = n(),
    mean = mean(mean_per_ul, na.rm = TRUE),
    sd = sd(mean_per_ul, na.rm = TRUE))


#add standard error
summary_plankton$se<- (summary_plankton$sd)/sqrt(summary_plankton$count)

#---

#create a "light column in data set

summary_plankton <- summary_plankton%>%
  mutate(treatment = as.character(treatment)) %>%
  mutate(id = ifelse(grepl("..L$", treatment), "light", "dark"))%>%
  mutate(treatment = as.factor(treatment))%>%
  mutate(id=as.factor(id))


# to wrap labels
labels_p1<-str_wrap(c("Phosphate + Nitrate + Light", "Phosphate + Nitrate + Dark", "Phosphate + Light", "Phosphate + Dark","Nitrate + Light", "Nitrate + Dark", "Light", "Dark"), width=15)

p1<- ggplot(summary_plankton, aes(x=treatment, y=mean, fill=id)) + 
  geom_bar(stat="identity", color="black", alpha=0.7,
           position=position_dodge()) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2,
                 position=position_dodge(.9))+
   geom_point(data=plankton_no_monday_clean, aes(x = treatment, y=mean_per_ul), shape = 21, position = position_dodge(width = 1))+
   scale_fill_manual(labels = c("Light","Dark"), values = c("#00008B", "#008080"))

p1<-p1+ theme_classic()+
  xlab("Treatment")+
  ylab("Mean plankton abundance per microliter")+
  scale_x_discrete(labels= c("Phosphate \n + \n Nitrate", "Phosphate \n + \n Nitrate", "Phosphate", "Phosphate","Nitrate", "Nitrate", "No Spike", "No Spike")) +
  theme(
        axis.text.x = element_text(size = 14, angle=50, hjust=1),  # Adjust the size of x-axis labels
        axis.text.y = element_text(size = 14),  # Adjust the size of y-axis labels
        axis.title.x = element_text(size = 16, margin = margin(t = 10)),
        axis.title.y = element_text(size = 16, margin = margin(r = 10)))+
  labs(fill="Light Treatment")

p1
```

Boxplot:

```{r}
#Creating a dataset where plankton is either in a light or a dark treatment. To be used later on in stats...
plankton_no_monday_clean <- plankton_no_monday_clean%>%
  mutate(treatment = as.character(treatment)) %>%
  mutate(id = ifelse(grepl("..L$", treatment), "light", "dark"))%>%
  mutate(treatment = as.factor(treatment))

  
  plankton_no_monday_clean%>%
  ggplot(aes(as.factor(treatment), mean_per_ul, fill = as.factor(id))) +
  geom_boxplot(color="black", alpha=0.7)+
    scale_fill_manual(labels = c("Light","Dark"), values = c("#00008B", "#008080")) +
  theme_classic()+
  theme_classic()+
  xlab("Treatment")+
  ylab("Mean plankton abundance per microliter")+
  scale_x_discrete(labels= c("Phosphate \n + \n Nitrate", "Phosphate \n + \n Nitrate", "Phosphate", "Phosphate","Nitrate", "Nitrate", "No Spike", "No Spike")) +
  theme(
        axis.text.x = element_text(size = 12),  # Adjust the size of x-axis labels
        axis.text.y = element_text(size = 14),  # Adjust the size of y-axis labels
        axis.title.x = element_text(size = 16, margin = margin(t = 10)),
        axis.title.y = element_text(size = 16, margin = margin(r = 10)))+
  labs(fill="Light Treatment")



```

# Phytoplankton abundance vs Site

1.  Create linear model

```{r}
#first need to remove NA
plankton_total_clean<-plankton_total%>%
  na.omit(plankton_no_monday$mean_per_ul)

p_m2 <- lm(log(mean_per_ul) ~ site, data = plankton_total_clean)
summary(p_m2)
anova(p_m2)
plot(p_m2)

#normality
p_m2_resids <- resid(p_m2)
shapiro.test(p_m2_resids)
#homoscedasticity
bartlett.test(log(mean_per_ul) ~ site, data = plankton_no_monday_clean)

### Data meets assumptions
```

Site has a significant effect on phytoplankton abundance.

2.  Create the graphs

```{r}
plankton_total_clean$site<-as.factor(plankton_total_clean$site)


plankton_total_clean%>%
  ggplot(aes(site, mean_per_ul))+
  geom_boxplot(color="black", fill="#00008B", alpha=0.7)+
  geom_text(aes(x = 1, y = 7, label ="*"),
            vjust = 0.5, hjust = 0.5, color = "yellow", size = 10, fontface = "bold")+
  theme_classic()+
  theme_classic()+
  xlab("Site")+
  ylab("Mean plankton abundance per microliter")+
  theme(legend.position = "none",
        axis.text.x = element_text(size = 14),  # Adjust the size of x-axis labels
        axis.text.y = element_text(size = 14),  # Adjust the size of y-axis labels
        axis.title.x = element_text(size = 16, margin = margin(t = 10)),
        axis.title.y = element_text(size = 16, margin = margin(r = 10)))
```

# Stats to find a difference between sites that creates a difference in phytoplankton

1.  Load a new data set

```{r, warning=FALSE}
temp <- read_xlsx("data_lake_v7.xlsx", sheet = "Metadata") |>
  rename(treatment = sample) |>
  mutate(date = str_to_sentence(date)) |>
  mutate(treatment = str_to_upper(treatment))

plankton <- read_xlsx("data_lake_v7.xlsx", sheet = "Pretty_Plankton") |>
  mutate(mean_per_ul = as.numeric(mean_per_ul))

full <- temp |>
  mutate(treatment = str_to_upper(treatment)) |>
  select(date, site, treatment, temperature) |>
  full_join(plankton, join_by(site, treatment, date))

#clean and format data

plankton<- plankton%>%  na.omit()

full<- full%>%  na.omit()
full$temperature<- as.numeric(full$temperature)
full$site<-as.factor(full$site)
full$date<-as.factor(full$date)
```

## Temperature between sites

1.  Linear model

```{r}

temp_plankton_lm<- lm(log(temperature)~site, data=full)
summary(temp_plankton_lm)
anova(temp_plankton_lm)
plot(temp_plankton_lm)

#normality
temp_plankton_lm_resids <- resid(temp_plankton_lm)
shapiro.test(temp_plankton_lm_resids)
#homoscedasticity
bartlett.test(log(temperature)~site, data=full)

##data isn't normal
```

2.  Use non-parametrical alternative

```{r}
kruskal.test(temperature~site, data=full)
```

Temperature differs significantly by site. How? Dunn Test:

```{r}
posthoc <- dunn.test(full$temperature, g = full$site, method = "bonferroni")
posthoc
```

Site 4 differs significantly with sites 3 and 1

```{r}
#include day as a factor
temp_day_plankton_lm<- lm(log(temperature)~site+date, data=full)
anova(temp_day_plankton_lm)
plot(temp_day_plankton_lm)

#doesn't meet normality
#no non-parametric alternative
```

3.  Graph

```{r}
#graph of temp by site

 full%>% 
   ggplot(aes(site, temperature))+
  geom_boxplot(position = position_dodge(width = 5), color="black", fill="#00008B", alpha=0.7)+
  theme_classic()+
  theme_classic()+
  xlab("Site")+
  ylab("Mean Temperature (ºC)")+
  scale_x_discrete(labels= c("\nS1", "\nS2", "\nS3", "\nS4"))+
  theme(legend.position = "none",
        axis.text.x = element_text(size = 12, margin = margin(b=20)),  # Adjust the size of x-axis labels
        axis.text.y = element_text(size = 12),  # Adjust the size of y-axis labels
        axis.title.x = element_text(size = 14, margin = margin(t = 10)),
        axis.title.y = element_text(size = 14, margin = margin(r = 10)))


#divided by day

full%>% 
   ggplot(aes(site, temperature))+
  geom_boxplot(position = position_dodge(width = 5), color="black", fill="#00008B", alpha=0.7)+
  theme_classic()+
  theme_classic()+
  xlab("Site")+
  ylab("Mean Temperature (ºC)")+
  scale_x_discrete(labels= c("\nS1", "\nS2", "\nS3", "\nS4"))+
  theme(legend.position = "none",
        axis.text.x = element_text(size = 12, margin = margin(b=20)),  # Adjust the size of x-axis labels
        axis.text.y = element_text(size = 12),  # Adjust the size of y-axis labels
        axis.title.x = element_text(size = 14, margin = margin(t = 10)),
        axis.title.y = element_text(size = 14, margin = margin(r = 10)))+
  facet_wrap(~as.factor(date))
```

# Background Statistical Analysis

## Background Temperature

1.  Load a different data set and make ajustments

```{r}
NPB<- read_xlsx("LAKE4.xlsx", sheet="N and P Concentrations")


metadata<- read_xlsx("LAKE4.xlsx", sheet="Metadata")

str(metadata)         #check structure

#make necessary changes
metadata$site<- as.factor(metadata$site)
metadata$temperature<- as.numeric(metadata$temperature)
metadata<- metadata[-c(33,46,65,74,77,78),] #remove temperature NAs
```

2.  Create summary tables

```{R}
summary_temp<- group_by(metadata, site) %>%
 summarise(
   count = n(),
   mean = mean(temperature, na.rm = TRUE),
   sd = sd(temperature, na.rm= TRUE))
summary_temp$se<- (summary_temp$sd)/sqrt(summary_temp$count)
```

## Background Values

1.  Load new data set

```{r}

#need information from 2 differnet data sets

#load first one
temp <- read_xlsx("data_lake_v7.xlsx", sheet = "Metadata") |>
  select(site, sample, date, temperature) |>
  filter(date %in% "mon") |>
  mutate(temperature = as.numeric(temperature)) |>
  group_by(site) |>
  summarise(mean_temp = mean(temperature)) |>
  rename(Site = site)

#load second one and combine
meta <- read_xlsx("LAKE4.xlsx", sheet = "N and P Concentrations") |>
  full_join(temp, by = "Site") |>
  pivot_longer(!Site, names_to = "measurment", values_to = "value") 
 

```


2. Generate graph

```{r}

#graph 1
(meta_hist <- ggplot(meta |> filter(!measurment %in% "mean_temp"), aes(x = as.factor(Site), y = value, fill = as.factor(measurment)) ) +
  geom_bar(position = "dodge", stat="identity") +
  labs(fill = "Measuremnt") +
    # geom_boxplot(color="black", fill="#008080", alpha=0.4)+
    theme_classic()+
    ylab("mg/L")+
    xlab("Site")+
    theme(
          axis.text.x = element_text(size = 14),  # Adjust the size of x-axis labels
          axis.text.y = element_text(size = 14),  # Adjust the size of y-axis labels
          axis.title.x = element_text(size = 16, margin = margin(t = 10)),
          axis.title.y = element_text(size = 16, margin = margin(r = 10)), 
          legend.text = element_text(size = 12), 
          legend.title = element_text(size = 14)) +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ ., name = "°C"))
)


#graph 2
(temp_hist <- ggplot(meta |> filter(measurment %in% "mean_temp"), aes(x = as.factor(Site), y = value, fill = as.factor(measurment)) ) +
  geom_bar(position = "dodge", stat="identity") +
  theme_classic()+
  ylab("Celciues")+
  xlab("Site")+
  labs(fill = "Measuremnt") +
  scale_fill_manual(labels = "Temperature", values =  "#FFA500") +
  scale_y_continuous(position = "right") +
  theme(
    axis.text.x = element_text(size = 14),  # Adjust the size of x-axis labels
    axis.text.y = element_text(size = 14),  # Adjust the size of y-axis labels
    axis.title.x = element_text(size = 16, margin = margin(t = 10)),
    axis.title.y = element_text(size = 16, margin = margin(r = 10)), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14)) 
)

# Combine both graphs
(combined_plot <- meta_hist + temp_hist) 

(test <- ggplot(meta, aes(x = Site, y = measurment)) +
    geom_bar(data = subset(meta, measurment == c("nitrate_mg_L", "phosphate_mg_L", "DOC_mg_L")), aes(x = as.factor(Site), y = value, fill = measurment),
             position = "dodge", stat = "identity") +
    #scale_fill_manual(labels = c("DOC", "Nitrate", "Phosphate"), values = c("#87CEEB", "#336699", "#000080")) +
    geom_line(data = subset(meta, measurment == "mean_temp"), aes(group = 1), color = "red"))

line <- geom_line(data = meta |> filter(!measurment %in% "mean_temp"), aes(x = as.factor(Site), y = value, group = measurment), color = "red")
```
